# AWS CLI and EKS Setup guide

In this lab exercise, we will create a managed Kubernetes cluster, AWS EKS, using the `aws` CLI and `eksctl` tool 

## What is AWS EKS?

The Amazon Elastic Kubernetes Service is an AWS-based service that manages
Kubernetes infrastructure. The responsibility of managing the infrastructure is
offloaded to AWS, ensuring that these resources are highly available and
dependable at all times.

## AWS Regions, Availability Zones, and naming convention suggestions


1. Check out the available [AWS
   Regions](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Concepts.RegionsAndAvailabilityZones.html).
   Decide on a [Datacenter
   region](https://aws.amazon.com/about-aws/global-infrastructure/) that is
   closest to you and meets your needs. Check out the [AWS latency
   test](https://ping.psa.fun/)! We will need to choose one and input a region
   name in the following steps.
1. Consider a naming and tagging convention to organize your cloud assets to
   support user identification of shared subscriptions. We discuss this in "[Setup Amazon EKS](#setup-eks)"


## AWS CLI Basic Settings (Configuration and Credential File Settings)

Using the AWS Command Line Interface (CLI) installed on your client machine or development container
we can provisionmanage our AWS services. for more tips on using the AWS cli tool, see [Installing, updating, and uninstalling the AWS
CLI](https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-install.html)

**Note:** The `aws configure` commands to setup your aws cli client needs to be
run the first time or each time your development container is built

1. Configure the client using `aws configure`

   ```bash
   # Access your "My Security Credentials" section in your profile. 
   # Create or Obtain your access key

   aws configure

   AWS Access Key ID [None]: [YOUR KEY ID]
   AWS Secret Access Key [None]: [YOUR AWS KEY]
   Default region name [None]: us-west-2
   Default output format [None]: json
   ```

We can inspect the files generated by the CLI using the `aws configure`  

1. Check `~/.aws/credentials` settings

   ```bash
   cat ~/.aws/credentials

   [default]
   aws_access_key_id = [YOUR KEY]
   aws_secret_access_key = [YOUR KEY]
   ```

1. You can check your AWS CLI settings in `~/.aws/config`, at any time

   ```bash
   cat ~/.aws/config

   [default]
   region = us-west-2
   output = json
   ```

   **Note:** For file examples with multiple named profiles, see [Named
   profiles](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-profiles.html).


1. Let's try our first AWS CLI command. Get a list of all of the Regions that are
   enabled for your account:

   ```bash
   aws ec2 describe-regions | grep RegionName
   ```

## Deploy a Kubernetes Cluster with AWS CLI

You can deploy a cluster using multiple methods. Common methods for AWS include
using the
[AWS](https://docs.aws.amazon.com/eks/latest/userguide/getting-started-console.html)
CLI or
[EKS](https://docs.aws.amazon.com/eks/latest/userguide/getting-started-eksctl.html)
CLI, `eksctl` (newer). 

For this lab we will use `eksctl`.

### What is [`eksctl`](https://eksctl.io/) ?

[eksctl](https://eksctl.io/) is a simple CLI tool for creating clusters on EKS;
eksctl is now the [official command line for
EKS](https://aws.amazon.com/blogs/opensource/eksctl-eks-cli/)

Check out [Installing or upgrading eksctl](https://eksctl.io/) and review some
standard command-line options in the [eksctl
introduction](https://eksctl.io/introduction/)

### Setup Amazon EKS {#setup-eks}

For this lab, we will be creating an EKS cluster. Consider a naming and tagging
convention to organize your cloud assets to support user identification of
shared subscriptions. 

**Example:** 

I am located in Denver, Colorado; I will opt to use the Datacenter region
`us-west-2` is based in US West (Oregon). I could also use the following naming
convention:

```bash
<Asset_type>-<your_id_yourname>-<location>-<###>
```

So for my EKS Cluster, I will deploy in US West (Oregon), i.e., `us-west-2 `, and
will name my Cluster `eks-armand-us-west-2` or just `aks-armand-uswest2` since I
don't intend to have more than one EKS deployment in this region

I will also use the tag `user=armand` to further identify my asset on our shared
account

1. For this lab, we will be creating an EKS cluster using the `eksctl` tool. We
   can test that our installation was successful with the following command.

   ```bash
   eksctl version
   ```

1. Use `eksctl` to create a production-ready EKS cluster with some options in a
   single command. **This will take a while** (Over 20 minutes):

   ```bash
   MY_REGION=us-west-2
   MY_EKS=eks-armand-uswest2
   MY_NAME=armand

   eksctl create cluster \
      --name=$MY_EKS \
      --region=$MY_REGION \
      --nodes=3 \
      --tags user=$MY_NAME \
      --version=1.21 # or leave out to install default version
   ```

1. Run the following command to check your eks clusters provisioned

   ```bash
   eksctl get cluster
   2022-05-05 21:34:35 [ℹ]  eksctl version 0.95.0
   2022-05-05 21:34:35 [ℹ]  using region us-west-2

   NAME                    REGION          EKSCTL CREATED
   eks-armand-uswest2      us-west-2       True
   ```

1. To create or update the `kubeconfig` file for your cluster, run the following
   command:

   ```bash
   MY_REGION=us-west-2
   MY_EKS=eks-armand-uswest2

   aws eks --region $MY_REGION update-kubeconfig --name $MY_EKS
   ```

1. If you are managing multiple Kubernetes clusters, you can easily change
   between context using the `kubectl config set-context` command:

   ```bash
   # Get a list of Kubernetes clusters in your local Kube config
   kubectl config get-clusters

   NAME
   eks-armand-uswest2.us-west-2.eksctl.io

   # Set context
   kubectl config set-context eks-armand-uswest2.us-west-2.eksctl.io

   # Check which context you are currently targeting
   kubectl config current-context

   # Get Nodes in the target Kubernetes cluster
   kubectl get nodes

   NAME                                           STATUS   ROLES    AGE     VERSION
   ip-192-168-30-155.us-west-2.compute.internal   Ready    <none>   5d23h   v1.22.6-eks-7d68063
   ip-192-168-48-238.us-west-2.compute.internal   Ready    <none>   5d23h   v1.22.6-eks-7d68063
   ip-192-168-74-60.us-west-2.compute.internal    Ready    <none>   5d23h   v1.22.6-eks-7d68063

   ```

---

We have successfully deployed our kubernetes cluster - Go back to [Table of Contents](../../README.md)